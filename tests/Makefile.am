RNG=$(top_srcdir)/data/xml/interface.rng

GNULIB= ../gnulib/lib/libgnu.la
GNULIB_CFLAGS= -I $(top_srcdir)/gnulib/lib

AM_CFLAGS = $(NETCF_CFLAGS) $(WARN_CFLAGS) $(GNULIB_CFLAGS) \
	$(LIBXML_CFLAGS) -I $(top_builddir)/src

EXTRA_DIST = interface redhat

TESTS_ENVIRONMENT = \
  PATH='$(abs_top_builddir)/src$(PATH_SEPARATOR)'"$$PATH" \
  NETCF_DATADIR='$(abs_top_srcdir)/data' \
  abs_top_builddir='$(abs_top_builddir)' \
  abs_top_srcdir='$(abs_top_srcdir)'

INCLUDES = -I$(top_srcdir)/src

TESTS=
check_PROGRAMS=

DRIVER_SOURCES_SHARED =  cutest.c cutest.h tutil.c tutil.h
DRIVER_SOURCES_REDHAT = test-redhat.c
DRIVER_SOURCES_DEBIAN = test-debian.c
DRIVER_SOURCES_SUSE = test-suse.c
DRIVER_SOURCES_FREEBSD = test-freebsd.c mock-freebsd.c
EXTRA_DIST += \
	$(DRIVER_SOURCES_SHARED) \
	$(DRIVER_SOURCES_REDHAT) \
	$(DRIVER_SOURCES_DEBIAN) \
	$(DRIVER_SOURCES_SUSE) \
	$(DRIVER_SOURCES_FREEBSD)

if NETCF_DRIVER_REDHAT
TESTS += test-redhat
check_PROGRAMS += test-redhat

test_redhat_SOURCES = $(DRIVER_SOURCES_REDHAT) $(DRIVER_SOURCES_SHARED)
test_redhat_LDADD = $(top_builddir)/src/libnetcf.la $(GNULIB)
endif

if NETCF_DRIVER_DEBIAN
TESTS += test-debian
check_PROGRAMS+=test-debian

test_debian_SOURCES = $(DRIVER_SOURCES_DEBIAN) $(DRIVER_SOURCES_SHARED)
test_debian_LDADD = $(top_builddir)/src/libnetcf.la $(GNULIB)
endif

if NETCF_DRIVER_SUSE
TESTS += test-suse
check_PROGRAMS+=test-suse

test_suse_SOURCES = $(DRIVER_SOURCES_SUSE) $(DRIVER_SOURCES_SHARED)
test_suse_LDADD = $(top_builddir)/src/libnetcf.la $(GNULIB)
endif

if NETCF_DRIVER_FREEBSD
TESTS += test-freebsd
check_PROGRAMS+=test-freebsd

test_freebsd_SOURCES = $(DRIVER_SOURCES_FREEBSD) $(DRIVER_SOURCES_SHARED)
test_freebsd_LDADD = $(top_builddir)/src/libnetcf.la $(GNULIB)
endif

# Clean up files generated by test programs
distclean-local:
if NETCF_DRIVER_REDHAT
	@chmod -R u+w $(top_builddir)/build/test_redhat || :
	@rm -rf $(top_builddir)/build/test_redhat
endif
if NETCF_DRIVER_DEBIAN
	@chmod -R u+w $(top_builddir)/build/test_debian || :
	@rm -rf $(top_builddir)/build/test_debian
endif
if NETCF_DRIVER_SUSE
	@chmod -R u+w $(top_builddir)/build/test_suse || :
	@rm -rf $(top_builddir)/build/test_suse
endif
if NETCF_DRIVER_FREEBSD
	@chmod -R u+w $(top_builddir)/build/test_freebsd || :
	@rm -rf $(top_builddir)/build/test_freebsd
endif

xmllint:
	@(for f in interface/*.xml; do                       \
	    if [ $$(basename $$f) != "schemas.xml" ] ; then  \
	      xmllint -relaxng $(RNG) -noout $$f             \
	        || echo FAIL;                                \
            fi;                                              \
	  done)
